generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model AuthSession {
  id        String   @id
  email     String
  intent    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email, intent])
  @@map("auth_sessions")
}

model Invite {
  id        String    @id @default(uuid())
  email     String    @unique
  token     String    @unique
  invitedBy String
  desc      String?
  expiresAt DateTime
  used      Boolean   @default(false)
  createdAt DateTime  @default(now())
  usedAt    DateTime?
  role      UserRole  @default(ADMIN)

  @@index([email, expiresAt])
  @@index([token])
  @@map("invites")
}

model User {
  id                  String            @id @default(uuid())
  email               String            @unique
  passwordHash        String
  role                UserRole          @default(USER)
  name                String            @default("")
  firstName           String            @default("")
  lastName            String?
  username            String?           @unique
  phoneNumber         String?           @unique
  avatar              String?
  directAvatarUrl     String?
  bio                 String?
  dob                 DateTime?
  theme               String?           @default("light")
  font                String?           @default("inter")
  language            String?
  notificationType    String?           @default("all")
  displayItems        Json?             @default("[\"recents\", \"home\", \"applications\", \"desktop\", \"downloads\", \"documents\"]")
  urls                Json?             @default("[]")
  communicationEmails Boolean?          @default(false)
  marketingEmails     Boolean?          @default(false)
  securityEmails      Boolean?          @default(true)
  socialEmails        Boolean?          @default(false)
  mobileNotifications Boolean?          @default(false)
  isPremium           Boolean           @default(false)
  stripeCustomerId    String?           @unique
  isActive            Boolean           @default(true)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  achievements        UserAchievement[]  @relation("UserAchievements")
  sessions            UserSession[]
  socialAccounts      SocialAccount[]   @relation("UserSocialAccounts")

  // Notices management
  notices             Notice[]           @relation("UserNotices")

  // Marketplace relations
  sellPosts              ItemSellPost[]              @relation("UserSellPosts")
  buyerOffers            ItemOffer[]                 @relation("UserBuyerOffers")
  sellerConversations    Conversation[]              @relation("UserSellerConversations")
  buyerConversations     Conversation[]              @relation("UserBuyerConversations")
  sentMessages           Message[]                   @relation("UserSentMessages")
  givenReviews           SellerReview[]              @relation("UserGivenReviews")
  sellPostViews          ItemSellPostView[]          @relation("UserSellPostViews")

  // Notifications
  notifications          Notification[]

  // WebSocket features
  onlineStatus           OnlineStatus?              @relation("UserOnlineStatus")
  typingIndicators       TypingIndicator[]          @relation("UserTypingIndicators")

  // Activity tracking
  activities             ActivityLog[]              @relation("UserActivities")

  // Support tickets
  tickets                SupportTicket[]            @relation("UserTickets")
  assignedTickets        SupportTicket[]            @relation("AssignedTickets")
  ticketResponses        TicketResponse[]           @relation("TicketResponses")

  // Legal content management
  updatedLegalContent    LegalContent[]            @relation("UserLegalContent")

  // Campaign management
  campaigns              Campaign[]                @relation("UserCampaigns")

  // Gamified Campaigns
  campaignProgress       UserCampaignProgress[]    @relation()
  createdTasks           CampaignTask[]            @relation("TaskCreator")
  createdCampaigns       GamifiedCampaign[]        @relation("CampaignCreator")
  submittedTasks         UserTaskSubmission[]      @relation("TaskSubmitter")
  reviewedTasks          UserTaskSubmission[]      @relation("TaskReviewer")
  validatedProofs        ProofSubmission[]         @relation("ProofValidator")

  // Teams
  captainedTeams         Team[]                   @relation("TeamCaptain")
  teamMemberships        TeamMembership[]         @relation("TeamMembers")

  // Templates
  createdTemplates       CampaignTemplate[]       @relation("TemplateCreator")
  createdSponsors        Sponsor[]                @relation("SponsorCreator")

  // Blog & Community
  blogPosts              BlogPost[]                @relation("UserBlogPosts")
  blogComments           BlogComment[]             @relation("UserBlogComments")

  // Subscription management
  subscription           Subscription?

  @@map("users")
}

// ============================================================================
// WEBSOCKET MODELS
// ============================================================================

model OnlineStatus {
  id          String     @id @default(uuid())
  userId      String     @unique
  socketId    String?
  status      UserStatus @default(OFFLINE)
  lastSeenAt  DateTime   @default(now())
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  user        User       @relation("UserOnlineStatus", fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, lastSeenAt])
  @@map("online_status")
}

model TypingIndicator {
  id               String       @id @default(uuid())
  conversationId   String
  userId           String
  isTyping         Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  conversation     Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user             User         @relation("UserTypingIndicators", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@map("typing_indicators")
}

model UserOtp {
  id        String   @id @default(uuid())
  email     String
  codeHash  String
  intent    String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email, intent])
  @@map("user_otps")
}

model UserSession {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique
  tokenType    TokenType @default(ACCESS) // ACCESS or REFRESH
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  revokedAt    DateTime?
  userAgent    String?
  ipAddress    String?
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId, tokenType])
  @@index([expiresAt])
  @@map("user_sessions")
}

enum TokenType {
  ACCESS   // Short-lived token (15 minutes)
  REFRESH  // Long-lived token (7 days)
}

// ============================================================================
// SOCIAL LOGIN / OAUTH
// ============================================================================

enum SocialProvider {
  GOOGLE
  GITHUB
}

model SocialAccount {
  id              String          @id @default(uuid())
  userId          String
  provider        SocialProvider
  providerAccountId String       @unique // Provider's unique ID for the user
  providerEmail   String?        // Email from provider
  accessToken     String?        @db.Text // OAuth access token
  refreshToken    String?        @db.Text // OAuth refresh token (if available)
  tokenExpiresAt  DateTime?      // Access token expiration
  avatar          String?        // Profile picture from provider
  profileUrl      String?        // Profile URL from provider
  isActive        Boolean        @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  lastUsedAt      DateTime        @default(now())

  user            User            @relation("UserSocialAccounts", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([provider, providerAccountId])
  @@map("social_accounts")
}

// ============================================================================
// SUBSCRIPTION MANAGEMENT
// ============================================================================

enum SubscriptionPlan {
  FREE
  PREMIUM
  PREMIUM_PLUS
}

model Subscription {
  id                  String           @id @default(uuid())
  userId              String           @unique
  plan                SubscriptionPlan @default(FREE)
  startDate           DateTime         @default(now())
  endDate             DateTime?
  isActive            Boolean          @default(true)
  paymentId           String?
  stripeSubscriptionId String?         @unique
  stripePriceId       String?
  cancelAtPeriodEnd   Boolean          @default(false)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  user                User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// ============================================================================
// CONTENT MANAGEMENT (Pricing & FAQ)
// ============================================================================

model PricingTier {
  id               String           @id @default(uuid())
  plan             SubscriptionPlan @unique
  name             String
  description      String
  monthlyPrice     Int              @default(0) // in cents
  yearlyPrice      Int              @default(0) // in cents
  popular          Boolean          @default(false)
  stripeMonthlyPriceId String?
  stripeYearlyPriceId  String?
  isActive         Boolean          @default(true)
  order            Int              @default(0)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  features         PricingFeature[]

  @@map("pricing_tiers")
}

model PricingFeature {
  id           String     @id @default(uuid())
  tierId       String
  text         String
  included     Boolean    @default(true)
  order        Int        @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  tier         PricingTier @relation(fields: [tierId], references: [id], onDelete: Cascade)

  @@map("pricing_features")
}

// ============================================================================
// CAMPAIGN MANAGEMENT
// ============================================================================

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
  CANCELLED
}

enum CampaignType {
  ONE_TIME       // Send once immediately or scheduled
  RECURRING      // Recurring campaign (cron-based)
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

model Campaign {
  id                String                @id @default(uuid())
  name              String
  subject           String
  previewText       String?
  htmlContent       String                @db.Text
  markdownContent   String                @db.Text  // Store original markdown

  // Campaign type
  type              CampaignType          @default(ONE_TIME)

  // Recipients
  targetAllUsers    Boolean               @default(true)
  targetRole        UserRole?
  recipientCount    Int                   @default(0)

  // Status tracking
  status            CampaignStatus        @default(DRAFT)
  scheduledAt       DateTime?
  sentAt            DateTime?

  // Recurring settings (for RECURRING type)
  isRecurring       Boolean               @default(false)
  recurrenceFrequency RecurrenceFrequency?
  recurrenceCron    String?               // Custom cron expression
  recurrenceEndDate  DateTime?            // When to stop recurring
  nextRunAt         DateTime?             // Next scheduled run for recurring

  // Delivery stats
  sentCount         Int                   @default(0)
  deliveredCount    Int                   @default(0)
  failedCount       Int                   @default(0)
  openedCount       Int                   @default(0)
  clickedCount      Int                   @default(0)

  // Unsubscribe tracking
  unsubscribeCount  Int                   @default(0)

  // Metadata
  entryById         String
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  entryBy           User                  @relation("UserCampaigns", fields: [entryById], references: [id])
  recipients        CampaignRecipient[]

  @@index([status, createdAt(sort: Desc)])
  @@index([entryById])
  @@index([nextRunAt])
  @@map("campaigns")
}

model CampaignRecipient {
  id                String         @id @default(uuid())
  campaignId        String
  userId            String
  userEmail         String         // Denormalized for filtering

  // Delivery status
  status            CampaignStatus @default(DRAFT)
  sentAt            DateTime?
  deliveredAt       DateTime?
  openedAt          DateTime?
  clickedAt         DateTime?
  unsubscribedAt    DateTime?      // When user unsubscribed from this campaign
  failedReason      String?

  // Engagement tracking (for links clicked)
  clickedLinks      Json?          // Track which links were clicked

  // Retry tracking
  retryCount        Int            @default(0)
  lastRetryAt       DateTime?

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  campaign          Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, userId])
  @@index([campaignId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("campaign_recipients")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

// ============================================================================
// MARKETPLACE ENUMS
// ============================================================================

enum ItemCondition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
  POOR
}

enum SellPostStatus {
  AVAILABLE
  PENDING
  SOLD
  EXPIRED
  HIDDEN
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  COUNTERED
  WITHDRAWN
  EXPIRED
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
  COMPLETED
  BLOCKED
}

// ============================================================================
// MARKETPLACE MODELS
// ============================================================================

model ItemSellPost {
  id                String             @id @default(uuid())
  title             String
  description       String?            @db.Text
  price             Float
  negotiable        Boolean            @default(true)
  condition         ItemCondition
  images            String[]           // Array of image URLs
  directImageUrls   Json?              // Store direct URLs for each image

  // Seller info
  sellerId          String
  seller            User               @relation("UserSellPosts", fields: [sellerId], references: [id], onDelete: Cascade)

  // Location for meetup
  location          String?
  city              String?

  // Status
  status            SellPostStatus     @default(AVAILABLE)
  soldAt            DateTime?

  // Timestamps
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  expiresAt         DateTime?          // Optional expiration for listings

  // Relations
  offers            ItemOffer[]
  conversations     Conversation[]
  reviews           SellerReview[]

  // Analytics
  views             ItemSellPostView[]

  @@index([sellerId, status])
  @@index([status, createdAt])
  @@map("item_sell_posts")
}

model ItemOffer {
  id                String             @id @default(uuid())
  sellPostId        String
  sellPost          ItemSellPost       @relation(fields: [sellPostId], references: [id], onDelete: Cascade)

  buyerId           String
  buyer             User               @relation("UserBuyerOffers", fields: [buyerId], references: [id], onDelete: Cascade)

  offeredPrice      Float
  message           String?            @db.Text

  status            OfferStatus        @default(PENDING)
  respondedAt       DateTime?
  responseMessage   String?            @db.Text

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([sellPostId, status])
  @@index([buyerId, status])
  @@map("item_offers")
}

model Conversation {
  id                String             @id @default(uuid())
  sellPostId        String
  sellPost          ItemSellPost       @relation(fields: [sellPostId], references: [id], onDelete: Cascade)

  // Participants
  sellerId          String
  buyerId           String
  seller            User               @relation("UserSellerConversations", fields: [sellerId], references: [id], onDelete: Cascade)
  buyer             User               @relation("UserBuyerConversations", fields: [buyerId], references: [id], onDelete: Cascade)

  // Status
  status            ConversationStatus @default(ACTIVE)
  completedAt       DateTime?

  // Transaction completion (for reviews)
  transactionCompleted Boolean        @default(false)

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  messages          Message[]
  review            SellerReview?
  typingIndicators  TypingIndicator[]

  @@unique([sellPostId, buyerId])
  @@index([sellerId, status])
  @@index([buyerId, status])
  @@map("conversations")
}

model Message {
  id                String             @id @default(uuid())
  conversationId    String
  conversation      Conversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId          String
  sender            User               @relation("UserSentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  content           String             @db.Text

  // Read status
  readAt            DateTime?

  createdAt         DateTime           @default(now())

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@map("messages")
}

model SellerReview {
  id                String             @id @default(uuid())
  conversationId    String             @unique
  conversation      Conversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  sellPostId        String
  sellPost          ItemSellPost       @relation(fields: [sellPostId], references: [id], onDelete: Cascade)

  reviewerId        String             // The buyer who left the review
  reviewer          User               @relation("UserGivenReviews", fields: [reviewerId], references: [id], onDelete: Cascade)

  sellerId          String             // The seller being reviewed (denormalized for queries)

  rating            Int                // 1-5 stars

  // Review categories
  communicationRating     Int          @default(0)
  descriptionAccuracyRating Int       @default(0)
  meetupRating            Int          @default(0)

  comment           String?            @db.Text

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([sellerId])
  @@index([reviewerId])
  @@map("seller_reviews")
}

model ItemSellPostView {
  id                String             @id @default(uuid())
  sellPostId        String
  sellPost          ItemSellPost       @relation(fields: [sellPostId], references: [id], onDelete: Cascade)

  userId            String?            // Nullable for anonymous visits
  sessionId         String?            // For anonymous tracking

  visitedAt         DateTime           @default(now())
  ip                String?
  userAgent         String?
  referrer          String?

  user              User?              @relation("UserSellPostViews", fields: [userId], references: [id], onDelete: SetNull)

  @@index([sellPostId, visitedAt])
  @@index([userId, visitedAt])
  @@map("item_sell_post_views")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

enum NotificationType {
  NEW_MESSAGE
  NEW_OFFER
  OFFER_ACCEPTED
  OFFER_REJECTED
  OFFER_COUNTERED
  TRANSACTION_COMPLETE
  NEW_REVIEW
  POST_APPROVED
  POST_REJECTED
  MARKETPLACE_UPDATE
  TASK_APPROVED
  TASK_REJECTED
}

// WebSocket features
enum UserStatus {
  ONLINE
  AWAY
  OFFLINE
}

model Notification {
  id          String             @id @default(uuid())
  userId      String
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        NotificationType
  title       String
  message     String             @db.Text

  // Optional links to related entities
  linkUrl     String?

  // Read status
  isRead      Boolean            @default(false)
  readAt      DateTime?

  createdAt   DateTime           @default(now())

  @@index([userId, isRead, createdAt])
  @@index([userId, createdAt])
  @@map("notifications")
}

// ============================================================================
// SYSTEM SETTINGS
// ============================================================================

// System-wide settings
model SystemSettings {
  id                        String   @id @default(uuid())

  // Maintenance & Construction Mode
  underConstruction         Boolean  @default(false)
  underConstructionMessage  String?  @default("Site is under construction. Some features may not work as expected.")
  maintenanceMode           Boolean  @default(false)
  maintenanceMessage        String?

  // Branding
  siteName                  String   @default("Admin Template")
  siteSlogan                String?
  logoUrl                   String?
  directLogoUrl             String?
  faviconUrl                String?
  directFaviconUrl          String?

  // SEO Metadata
  seoTitle                  String?
  seoDescription            String?
  seoKeywords               String?
  ogImage                   String?
  directOgImageUrl          String?

  // Contact Information
  supportEmail              String?
  contactEmail              String?
  socialTwitter             String?
  socialGithub              String?
  socialFacebook            String?
  socialInstagram           String?
  socialLinkedIn            String?

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@map("system_settings")
}

// Notices/Announcements for users
model Notice {
  id           String    @id @default(uuid())
  title        String
  content      String    @db.Text
  isActive     Boolean   @default(true)
  validFrom    DateTime? // Optional start date
  validTo      DateTime? // Optional end date
  order        Int       @default(0) // Display order
  entryById    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  entryBy      User      @relation("UserNotices", fields: [entryById], references: [id])

  @@index([isActive, validFrom, validTo])
  @@map("notices")
}

// ============================================================================
// ACTIVITY & AUDIT LOGGING
// ============================================================================

enum ActivityAction {
  // CRUD
  CREATE
  UPDATE
  DELETE
  VIEW

  // Auth
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGED
  ROLE_CHANGED

  // Marketplace
  SELL_POST_CREATED
  SELL_POST_UPDATED
  SELL_POST_DELETED
  OFFER_CREATED
  OFFER_ACCEPTED
  OFFER_REJECTED
  MESSAGE_SENT
  REVIEW_POSTED

  // User
  PROFILE_UPDATED

  // System
  SYSTEM_SETTINGS_UPDATED
  NOTICE_CREATED
  NOTICE_UPDATED
  NOTICE_DELETED
  USER_BANNED
  USER_PROMOTED

  // Campaigns
  CAMPAIGN_CREATED
  CAMPAIGN_UPDATED
  CAMPAIGN_DELETED
  CAMPAIGN_SENT
  CAMPAIGN_CANCELLED

  // Blog
  BLOG_POST_CREATED
  BLOG_POST_UPDATED
  BLOG_POST_DELETED
  BLOG_COMMENT_CREATED

  // Support
  TICKET_CREATED
  TICKET_RESPONDED
  TICKET_RESOLVED
  TICKET_CLOSED

  // Legal
  LEGAL_CONTENT_UPDATED

  // Achievements
  ACHIEVEMENT_UNLOCKED

  // Gamified Campaigns (Legacy - keep for compatibility)
  TASK_CAMPAIGN_CREATED
  TASK_CAMPAIGN_UPDATED
  TASK_CAMPAIGN_STARTED
  TASK_CAMPAIGN_ENDED
  TASK_SUBMISSION_CREATED
  TASK_SUBMISSION_APPROVED
  TASK_SUBMISSION_REJECTED
  TASK_ACHIEVEMENT_UNLOCKED
  TASK_CAMPAIGN_ENROLLED
  TASK_CAMPAIGN_COMPLETED

  // Gamified Campaigns (New)
  TASK_CREATED
  TASK_UPDATED
  TASK_DELETED
  TASK_SUBMITTED
  TASK_APPROVED
  TASK_REJECTED
  CAMPAIGN_GAMIFIED_CREATED
  CAMPAIGN_GAMIFIED_UPDATED
  CAMPAIGN_GAMIFIED_JOINED
  CAMPAIGN_GAMIFIED_COMPLETED
  PROOF_VALIDATED
}

enum ActivityResourceType {
  USER
  SELL_POST
  OFFER
  MESSAGE
  CONVERSATION
  REVIEW
  NOTICE
  SYSTEM_SETTINGS
  ACHIEVEMENT
  CAMPAIGN
  BLOG_POST
  BLOG_COMMENT
  SUPPORT_TICKET
  LEGAL_CONTENT
  PRICING_TIER
  FAQ
  // Legacy - keep for compatibility
  TASK_CAMPAIGN
  TASK
  TASK_ACHIEVEMENT
  // New
  GAMIFIED_CAMPAIGN
  CAMPAIGN_TASK
  TASK_SUBMISSION
  PROOF_SUBMISSION
}

// ============================================================================
// ACHIEVEMENTS SYSTEM
// ============================================================================

model Achievement {
  id                String              @id @default(uuid())
  code              String              @unique  // e.g., 'FIRST_LOGIN', 'CONTRIBUTOR_10'
  name              String              // Display name
  description       String              @db.Text
  icon              String?             // Emoji or icon name
  category          AchievementCategory
  tier              AchievementTier     @default(BRONZE)
  xp                Int                 @default(0)  // Experience points rewarded

  // Requirements (stored as JSON for flexibility)
  requirements      Json                // { type: 'ITEMS_SOLD', count: 10, etc. }

  // Stats
  unlockCount       Int                 @default(0)  // How many users unlocked this
  isVisible         Boolean             @default(true)

  // Metadata
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  entryById         String

  userAchievements  UserAchievement[]

  @@index([category, tier])
  @@index([code])
  @@map("achievements")
}

model UserAchievement {
  id              String              @id @default(uuid())
  userId          String
  achievementId   String
  unlockedAt      DateTime            @default(now())

  // Progress tracking (for incremental achievements)
  progress        Int                 @default(0)
  maxProgress     Int                 @default(1)

  user            User                @relation("UserAchievements", fields: [userId], references: [id], onDelete: Cascade)
  achievement     Achievement         @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId, unlockedAt(sort: Desc)])
  @@index([achievementId])
  @@map("user_achievements")
}

enum AchievementCategory {
  CONTRIBUTION        // Items added, created
  MARKETPLACE       // Sell posts, offers, reviews
  SOCIAL            // Reviews, ratings, conversations
  ENGAGEMENT        // Logins, consistency, streaks
  SPECIAL           // Limited time, unique achievements
}

enum AchievementTier {
  BRONZE            // Entry level
  SILVER            // Intermediate
  GOLD              // Advanced
  PLATINUM          // Expert
  DIAMOND           // Master
  LEGENDARY         // Ultra rare
}

model ActivityLog {
  id                String              @id @default(uuid())

  // Who
  userId            String?
  user              User?               @relation("UserActivities", fields: [userId], references: [id], onDelete: SetNull)
  userRole          UserRole?

  // What
  action            ActivityAction
  resourceType      ActivityResourceType
  resourceId        String?
  resourceName      String?             @db.Text

  // Details
  description       String?             @db.Text
  metadata          Json?
  ipAddress         String?
  userAgent         String?             @db.Text

  // Context
  endpoint          String?

  // Result
  success           Boolean             @default(true)
  errorMessage      String?             @db.Text

  // Performance
  duration          Int?                // ms

  // Timestamp
  createdAt         DateTime            @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([resourceType, resourceId, createdAt])
  @@index([action, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("activity_logs")
}

// ============================================================================
// SUPPORT TICKETS SYSTEM
// ============================================================================

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_USER
  RESOLVED
  CLOSED
}

model SupportTicket {
  id                String           @id @default(uuid())

  // User info
  userId            String
  user              User             @relation("UserTickets", fields: [userId], references: [id], onDelete: Cascade)
  userEmail          String
  userName           String

  // Ticket details
  subject           String
  description       String           @db.Text
  category          String           // e.g., 'technical', 'billing', 'feature', 'bug'
  priority          TicketPriority   @default(MEDIUM)
  status            TicketStatus     @default(OPEN)

  // Admin assignment
  assignedToId      String?
  assignedTo        User?            @relation("AssignedTickets", fields: [assignedToId], references: [id], onDelete: SetNull)

  // Resolution
  resolution        String?          @db.Text
  resolvedAt        DateTime?

  // Timestamps
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  closedAt          DateTime?

  // Relations
  responses         TicketResponse[]

  @@index([userId, status, createdAt(sort: Desc)])
  @@index([status, priority, createdAt(sort: Desc)])
  @@index([assignedToId, status])
  @@map("support_tickets")
}

model TicketResponse {
  id                String           @id @default(uuid())

  ticketId          String
  ticket            SupportTicket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  // Response info
  senderId          String
  sender            User             @relation("TicketResponses", fields: [senderId], references: [id], onDelete: Cascade)
  senderRole        UserRole         @default(USER)
  isFromAdmin       Boolean          @default(false)

  message           String           @db.Text

  // Attachments (optional)
  attachments       Json?            // Array of file URLs

  createdAt         DateTime         @default(now())

  @@index([ticketId, createdAt(sort: Asc)])
  @@map("ticket_responses")
}

// FAQ for help center
model FAQ {
  id                String           @id @default(uuid())

  question          String
  answer            String           @db.Text
  category          String           // e.g., 'account', 'billing', 'marketplace', 'technical'
  order             Int              @default(0)

  isActive          Boolean          @default(true)

  // Metadata
  views             Int              @default(0)
  helpfulCount      Int              @default(0)
  notHelpfulCount   Int              @default(0)

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([category, order])
  @@index([isActive])
  @@map("faqs")
}

// Legal content pages (Terms, Privacy, etc.)
model LegalContent {
  id                String           @id @default(uuid())
  type              LegalContentType @unique
  title             String
  content           String           @db.Text  // Markdown content
  lastUpdatedById   String
  lastUpdatedBy     User             @relation("UserLegalContent", fields: [lastUpdatedById], references: [id])
  effectiveDate     DateTime         @default(now())
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([type])
  @@map("legal_content")
}

enum LegalContentType {
  TERMS_OF_SERVICE
  PRIVACY_POLICY
  COOKIE_POLICY
  DISCLAIMER
  ABOUT
}

// ============================================================================
// BLOG & COMMUNITY
// ============================================================================

// Blog Categories for organizing posts
model BlogCategory {
  id          String      @id @default(uuid())
  name        String      @unique
  slug        String      @unique
  description String?     @db.Text
  order       Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  posts       BlogPost[]

  @@index([slug])
  @@index([order])
  @@map("blog_categories")
}

// Blog Tags for flexible categorization
model BlogTag {
  id        String      @id @default(uuid())
  name      String      @unique
  slug      String      @unique
  createdAt DateTime    @default(now())
  posts     BlogPostTag[]

  @@index([slug])
  @@map("blog_tags")
}

// Blog Posts - main content model
model BlogPost {
  id              String      @id @default(uuid())
  title           String
  slug            String      @unique
  excerpt         String?     @db.Text
  content         String      @db.Text
  coverImage      String?
  authorId        String
  author          User        @relation("UserBlogPosts", fields: [authorId], references: [id], onDelete: Cascade)
  categoryId      String?
  category        BlogCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags            BlogPostTag[]
  comments        BlogComment[]
  status          PostStatus  @default(DRAFT)
  publishedAt     DateTime?
  scheduledFor    DateTime?
  seoTitle        String?
  seoDescription  String?
  seoKeywords     String[]
  featured        Boolean     @default(false)
  allowComments   Boolean     @default(true)
  viewCount       Int         @default(0)
  readTime        Int?        // in minutes
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([slug])
  @@index([authorId])
  @@index([categoryId])
  @@index([status])
  @@index([publishedAt])
  @@index([featured])
  @@map("blog_posts")
}

// Junction table for posts-tags many-to-many
model BlogPostTag {
  postId    String
  tagId     String
  post      BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag       BlogTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@index([postId])
  @@index([tagId])
  @@map("blog_post_tags")
}

// Blog Comments
model BlogComment {
  id          String        @id @default(uuid())
  content     String        @db.Text
  authorId    String
  author      User          @relation("UserBlogComments", fields: [authorId], references: [id], onDelete: Cascade)
  postId      String
  post        BlogPost      @relation(fields: [postId], references: [id], onDelete: Cascade)
  parentId    String?
  parent      BlogComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     BlogComment[] @relation("CommentReplies")
  status      CommentStatus @default(APPROVED)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([postId])
  @@index([authorId])
  @@index([status])
  @@map("blog_comments")
}

enum PostStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
  SPAM
}

// ============================================================================
// CONTACT SUBMISSIONS
// ============================================================================

enum ContactStatus {
  NEW
  READ
  RESPONDED
  ARCHIVED
}

model ContactSubmission {
  id          String        @id @default(uuid())
  name        String
  email       String
  subject     String?
  message     String        @db.Text
  status      ContactStatus @default(NEW)
  ipAddress   String?
  userAgent   String?
  readAt      DateTime?
  respondedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([status, createdAt(sort: Desc)])
  @@index([email])
  @@map("contact_submissions")
}

// ============================================================================
// GAMIFIED CAMPAIGN MANAGEMENT SYSTEM
// ============================================================================

// Enums
enum TaskValidationType {
  AUTO        // Future: AI/ML validation
  MANUAL      // Admin review required
  ADMIN       // Admin-only, no user input
}

enum ProofType {
  IMAGE       // Image file
  AUDIO       // Audio file
  URL         // URL link
  TEXT        // Text description
}

enum ProofValidationStatus {
  PENDING     // Awaiting review
  APPROVED    // Validated
  REJECTED    // Rejected
  NEEDS_INFO  // Needs more info
}

enum CampaignProgressStatus {
  JOINED
  IN_PROGRESS
  COMPLETED
  DISQUALIFIED
}

enum SubmissionStatus {
  PENDING     // Awaiting action (legacy)
  DRAFT       // User working on it
  SUBMITTED   // Submitted for review
  APPROVED    // Approved
  REJECTED    // Rejected
  RESUBMIT    // Needs resubmission
}

enum DependencyType {
  ALL         // All prerequisite tasks must be completed
  ANY         // At least one prerequisite task must be completed
}

enum TeamRole {
  CAPTAIN     // Team creator/leader
  MEMBER      // Regular team member
}

enum TeamStatus {
  ACTIVE
  INACTIVE
  DISBANDED
}

enum TemplateDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

// Task Achievement - Rewards for completing tasks
model TaskAchievement {
  id              String      @id @default(uuid())
  taskId          String
  name            String
  description     String      @db.Text
  points          Int         @default(0)
  icon            String?
  imageUrl        String?
  directImageUrl  String?
  howToAchieve    String      @db.Text
  order           Int         @default(0)

  task            CampaignTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@map("task_achievements")
}

// Campaign Task - Individual task definition
model CampaignTask {
  id                      String              @id @default(uuid())
  name                    String
  description             String              @db.Text
  rules                   String              @db.Text
  disqualificationRules   String?             @db.Text
  startDate               DateTime
  endDate                 DateTime
  isActive                Boolean             @default(true)
  imageUrl                String?
  directImageUrl          String?
  validationType          TaskValidationType  @default(MANUAL)

  // Metadata
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  entryById               String

  // Relations
  entryBy                 User                @relation("TaskCreator", fields: [entryById], references: [id])
  achievements            TaskAchievement[]
  campaignTasks           CampaignToTask[]
  submissions             UserTaskSubmission[]
  dependencies            TaskDependency[]    @relation("TaskDependencies")
  dependants              TaskDependency[]    @relation("TaskDependants")

  @@index([isActive, startDate, endDate])
  @@index([entryById])
  @@map("campaign_tasks")
}

// Junction table for Campaign-Tasks many-to-many
model CampaignToTask {
  id          String            @id @default(uuid())
  campaignId  String
  taskId      String
  order       Int               @default(0)

  campaign    GamifiedCampaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  task        CampaignTask      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([campaignId, taskId])
  @@index([campaignId])
  @@index([taskId])
  @@map("campaign_to_tasks")
}

// Gamified Campaign - Collection of tasks
model GamifiedCampaign {
  id                      String              @id @default(uuid())
  name                    String
  description             String              @db.Text
  imageUrl                String?
  directImageUrl          String?
  startDate               DateTime
  endDate                 DateTime
  isActive                Boolean             @default(true)
  maxParticipants         Int?
  rules                   String?             @db.Text
  disqualificationRules   String?             @db.Text
  rewards                 Json?               @default("[]")

  // Metadata
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  entryById               String

  // Relations
  entryBy                 User                @relation("CampaignCreator", fields: [entryById], references: [id])
  tasks                   CampaignToTask[]
  participations          UserCampaignProgress[]

  @@index([isActive, startDate, endDate])
  @@index([entryById])
  @@map("gamified_campaigns")
}

// User Campaign Participation/Progress
model UserCampaignProgress {
  id              String                  @id @default(uuid())
  userId          String
  campaignId      String
  status          CampaignProgressStatus  @default(JOINED)
  joinedAt        DateTime                @default(now())
  completedAt     DateTime?
  totalPoints     Int                     @default(0)

  user            User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign        GamifiedCampaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  submissions     UserTaskSubmission[]

  @@unique([userId, campaignId])
  @@index([userId, status])
  @@index([campaignId, status])
  @@map("user_campaign_progress")
}

// User Task Submission
model UserTaskSubmission {
  id              String              @id @default(uuid())
  userId          String
  taskId          String
  campaignId      String
  progressId      String
  status          SubmissionStatus    @default(DRAFT)
  submittedAt     DateTime?
  reviewedAt      DateTime?
  reviewedById    String?
  feedback        String?             @db.Text

  user            User                @relation("TaskSubmitter", fields: [userId], references: [id], onDelete: Cascade)
  task            CampaignTask        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  progress        UserCampaignProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)
  reviewedBy      User?               @relation("TaskReviewer", fields: [reviewedById], references: [id])
  proofs          ProofSubmission[]

  @@unique([userId, taskId, campaignId])
  @@index([userId, status])
  @@index([campaignId, status])
  @@index([taskId, status])
  @@index([reviewedById])
  @@map("user_task_submissions")
}

// Proof Submission (files/URLs)
model ProofSubmission {
  id              String                  @id @default(uuid())
  submissionId    String
  type            ProofType
  fileUrl         String?
  directFileUrl   String?
  url             String?
  text            String?                 @db.Text
  validationStatus ProofValidationStatus @default(PENDING)
  validatedAt     DateTime?
  validatedById   String?
  adminNotes      String?                 @db.Text

  submission      UserTaskSubmission      @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  validatedBy     User?                   @relation("ProofValidator", fields: [validatedById], references: [id])

  @@index([submissionId, validationStatus])
  @@index([validatedById])
  @@map("proof_submissions")
}

// ============================================================================
// TASK DEPENDENCIES
// ============================================================================

model TaskDependency {
  id                String          @id @default(uuid())
  taskId            String
  dependsOnTaskId   String
  dependencyType    DependencyType  @default(ALL)
  order             Int             @default(0)

  task              CampaignTask    @relation("TaskDependencies", fields: [taskId], references: [id], onDelete: Cascade)
  dependsOn         CampaignTask    @relation("TaskDependants", fields: [dependsOnTaskId], references: [id], onDelete: Cascade)

  @@unique([taskId, dependsOnTaskId])
  @@index([taskId])
  @@index([dependsOnTaskId])
  @@map("task_dependencies")
}

// ============================================================================
// TEAMS
// ============================================================================

model Team {
  id                String          @id @default(uuid())
  name              String
  description       String?         @db.Text
  imageUrl          String?
  directImageUrl    String?
  captainId         String
  maxMembers        Int?
  status            TeamStatus      @default(ACTIVE)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  captain           User            @relation("TeamCaptain", fields: [captainId], references: [id])
  members           TeamMembership[]
  campaignProgress  TeamCampaignProgress[]

  @@index([status, createdAt])
  @@index([captainId])
  @@map("teams")
}

model TeamMembership {
  id                String          @id @default(uuid())
  teamId            String
  userId            String
  role              TeamRole        @default(MEMBER)
  joinedAt          DateTime        @default(now())
  pointsContributed Int             @default(0)

  team              Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user              User            @relation("TeamMembers", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_memberships")
}

model TeamCampaignProgress {
  id                  String                  @id @default(uuid())
  teamId              String
  campaignId          String
  status              CampaignProgressStatus  @default(JOINED)
  joinedAt            DateTime                @default(now())
  completedAt         DateTime?
  totalPoints         Int                     @default(0)
  totalTasksCompleted Int                     @default(0)

  team                Team                    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, campaignId])
  @@index([teamId, status])
  @@index([campaignId, status])
  @@map("team_campaign_progress")
}

// ============================================================================
// CAMPAIGN TEMPLATES
// ============================================================================

model CampaignTemplate {
  id                      String                @id @default(uuid())
  name                    String
  description             String?               @db.Text
  rules                   String?               @db.Text
  disqualificationRules   String?               @db.Text
  termsOfService          String?               @db.Text
  category                String?
  isPublic                Boolean               @default(false)
  isSystemTemplate        Boolean               @default(false)
  estimatedDuration       Int?                  // in hours
  difficulty              TemplateDifficulty    @default(INTERMEDIATE)
  imageUrl                String?
  directImageUrl          String?
  startDate               DateTime?
  endDate                 DateTime?
  minPointsToQualify      Int?                  @default(0)
  sponsorId               String?
  rewardsTemplate         Json?                 @default("[]")
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  entryById               String

  entryBy                 User                  @relation("TemplateCreator", fields: [entryById], references: [id])
  sponsor                 Sponsor?              @relation("CampaignTemplateSponsor", fields: [sponsorId], references: [id])
  templateTasks           TemplateTask[]

  @@index([isPublic, category])
  @@index([entryById])
  @@map("campaign_templates")
}

model TemplateTask {
  id                  String              @id @default(uuid())
  templateId          String
  name                String
  description         String              @db.Text
  rules               String              @db.Text
  disqualificationRules String?           @db.Text
  order               Int                 @default(0)
  points              Int                 @default(0)
  startDate           DateTime?
  endDate             DateTime?
  achievementsTemplate Json?               // Template for achievements

  template            CampaignTemplate    @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("template_tasks")
}

// ============================================================================
// SPONSORS
// ============================================================================

model Sponsor {
  id                String              @id @default(uuid())
  name              String
  description       String?             @db.Text
  logoUrl           String?
  directLogoUrl     String?
  websiteUrl        String?
  isActive          Boolean             @default(true)

  // Metadata
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  entryById         String

  entryBy           User                @relation("SponsorCreator", fields: [entryById], references: [id])

  // Relations
  campaignTemplates CampaignTemplate[] @relation("CampaignTemplateSponsor")

  @@index([isActive, createdAt])
  @@index([entryById])
  @@map("sponsors")
}